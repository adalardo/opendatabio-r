---
title: "opendatabio:importing"
author: "A. Chalom"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Importing data using the OpenDataBio R client}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# Importing data using the OpenDataBio R client

The `opendatabio` R package was created to allow data from an OpenDataBio server to be read, 
and to allow data to be easily imported to an OpenDataBio server. This vignette focus on data
imports.

# Setting up the connection

The first thing to do when starting the data import is to correctly set up the connection to
the OpenDataBio server using the `odb_config()` function. The most important parameters for
this function are `base_url`, which should point to the API url for your OpenDataBio server, and
`token`, which is the access token used to authenticate your user (you can find it in the 
"Token" menu item, when using the web interface). For data imports, all requests must have
an authorization token.

```r
> cfg = odb_config(base_url = "http://opendatabio.ib.usp.br/opendatabio/api",
+ token="YourToken")
```

More advanced configuration involves setting a specific API version, a custom User Agent, or
other HTTP headers, but this is not covered in this vignette.

The function `odb_test()` may be used to check if the connection was successful, and whether
your user was correctly identified:

```r
> odb_test(cfg)
$message
[1] "Success!"

$user
[1] "admin@example.org"
```

# OpenDataBio import functions
All import functions have the same signature: the first argument is a `data.frame` with data to
be imported, and the second parameter is a configuration object (generated by `odb_config`).

When writing an import request, check the 
[OpenDataBio API endpoints documentation](https://github.com/opendatabio/opendatabio/wiki/API-v0-endpoints) in order
to understand which columns can be declared in the `data.frame`. You may also want to check the 
[OpenDataBio API documentation](https://github.com/opendatabio/opendatabio/wiki/API) to see
a list of possible errors, along with other details.

All import functions return a job id, which can be used to check if the job is still running,
if it ended with success or if it encountered an error. This job id can be used in the functions
`odb_get_jobs()`, `odb_get_affected_ids()` and `odb_get_log()`, to find details about the job,
which (if any) were the IDs of the successfully imported objects, and the full log of the job.

```r
> odb_import_people(data, cfg)
Sending ODB request (filesize = 1856)
    id    created_at (...) Status
    127   2018-03-07 (...) Submitted
> odb_get_affected_ids(127, cfg)
[1] 41 42
> odb_get_log(127, cfg)
[1] "WARNING: There is another registry of a person with name like Jo√£o da Silva or abbreviation like SILVA, J."
```

## Importing taxons

You can import a list of taxons using the `odb_import_taxons` function. 

